{% extends 'base.html' %}

{% block content %}
<div class="space-y-8">
    <!-- Page Header -->
    <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 pb-4 border-b border-border">
        <div>
            <h2 class="text-2xl font-bold text-slate-800">Operational Overview</h2>
            <p class="text-slate-500 text-sm mt-1">
                {% if is_filtered %}
                    <span class="text-primary font-bold">Filtered View:</span> {{ start_date }} ~ {{ end_date }}
                {% else %}
                    Showing all time data
                {% endif %}
            </p>
        </div>

        <div class="flex flex-col md:flex-row items-center gap-3 w-full md:w-auto">
            <!-- ‚ñº‚ñº‚ñº ÊúüÈñìÊåáÂÆö„Éï„Ç©„Éº„É† ‚ñº‚ñº‚ñº -->
            <form method="get" class="flex items-center gap-2 bg-white p-1 rounded-md border border-border shadow-sm">
                <input type="date" name="start" value="{{ start_date|default:'' }}" required
                       class="text-sm text-slate-700 border-none focus:ring-0 rounded-sm bg-transparent px-2 py-1 outline-none">
                <span class="text-slate-400 text-xs">to</span>
                <input type="date" name="end" value="{{ end_date|default:'' }}" required
                       class="text-sm text-slate-700 border-none focus:ring-0 rounded-sm bg-transparent px-2 py-1 outline-none">
                
                <button type="submit" class="bg-primary text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-primary-hover transition-colors">
                    Apply
                </button>
                
                {% if is_filtered %}
                <a href="{% url 'dashboard' %}" class="text-slate-400 hover:text-slate-600 px-2 text-lg leading-none" title="Reset Filter">
                    √ó
                </a>
                {% endif %}
            </form>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ „Åì„Åì„Åæ„Åß ‚ñ≤‚ñ≤‚ñ≤ -->

            <!-- Print„Éú„Çø„É≥ -->
            <button onclick="window.print()" class="bg-white border border-border text-slate-600 px-3 py-2 text-sm font-medium rounded hover:bg-slate-50 hover:text-primary transition-colors shadow-sm">
                üñ®Ô∏è
            </button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- Card 1 -->
        <div class="card p-6 flex flex-col justify-between">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider">Departments</h3>
                <span class="text-2xl opacity-20">üè¢</span>
            </div>
            <p class="text-4xl font-bold text-slate-800">{{ total_depts }}</p>
        </div>
        <!-- Card 2 -->
        <div class="card p-6 flex flex-col justify-between">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider">Monitor Groups</h3>
                <span class="text-2xl opacity-20">üë•</span>
            </div>
            <p class="text-4xl font-bold text-slate-800">{{ total_groups }}</p>
        </div>
        <!-- Card 3 -->
        <div class="card p-6 border-l-4 border-l-primary flex flex-col justify-between">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-primary text-xs font-bold uppercase tracking-wider">Active Accounts</h3>
                <span class="text-2xl opacity-20 text-primary">‚òÅÔ∏è</span>
            </div>
            <p class="text-4xl font-bold text-slate-800">{{ total_accounts }}</p>
        </div>
        <!-- Card 4 -->
        <div class="card p-6 flex flex-col justify-between">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-emerald-600 text-xs font-bold uppercase tracking-wider">Connected</h3>
                <span class="text-2xl opacity-20 text-emerald-600">üü¢</span>
            </div>
            <div class="flex items-baseline gap-2">
                <p class="text-4xl font-bold text-slate-800">{{ connected_accounts }}</p>
                <span class="text-xs text-emerald-600 font-medium bg-emerald-50 px-2 py-0.5 rounded">Running</span>
            </div>
        </div>
    </div>

<!-- Â∑¶ÔºöÂÜÜ„Ç∞„É©„Éï„Å®Êï∞ÂÄ§„É™„Çπ„Éà -->
<div class="card p-6">
    <h3 class="text-sm font-bold text-slate-700 mb-6">Provider Distribution</h3>
    
    <div class="flex flex-col md:flex-row items-center gap-8">
        <!-- Â∑¶ÂÅ¥: „Ç∞„É©„Éï„Ç®„É™„Ç¢ -->
        <div class="w-full md:w-1/2 h-48 relative">
            <canvas id="providerChart"></canvas>
            <!-- ‰∏≠Â§Æ„Å´ÂêàË®à„ÇíË°®Á§∫„Åô„ÇãÊºîÂá∫ -->
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="text-center">
                    <span class="block text-xs text-slate-400">Total</span>
                    <span class="block text-xl font-bold text-slate-800">{{ total_accounts }}</span>
                </div>
            </div>
        </div>

        <!-- Âè≥ÂÅ¥: Êï∞ÂÄ§„É™„Çπ„Éà„Ç®„É™„Ç¢ -->
        <div class="w-full md:w-1/2 space-y-3">
            {% for item in provider_counts %}
            <div class="flex justify-between items-center p-2 rounded hover:bg-slate-50 border border-transparent hover:border-slate-100 transition-colors">
                <div class="flex items-center gap-3">
                    <!-- „Ç∞„É©„Éï„ÅÆËâ≤„Å®Âêå„ÅòÈ†ÜÂ∫è„Åß„Éâ„ÉÉ„Éà„ÇíË°®Á§∫ -->
                    <span class="w-3 h-3 rounded-full shadow-sm" 
                            style="background-color: {% cycle '#3B82F6' '#10B981' '#F59E0B' '#6366F1' '#EC4899' %}">
                    </span>
                    <span class="text-sm font-medium text-slate-600">{{ item.provider }}</span>
                </div>
                <div class="flex items-baseline gap-1">
                    <span class="text-lg font-bold text-slate-800">{{ item.count }}</span>
                    <span class="text-[10px] text-slate-400">acc</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

    <!-- Bottom Tables -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Attention List -->
        <div class="md:col-span-2 card overflow-hidden">
            <div class="p-4 border-b border-border bg-slate-50 flex justify-between items-center">
                <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-amber-500"></span> Attention Required
                </h3>
            </div>
            <table class="w-full text-sm text-left">
                <thead class="bg-slate-50 text-slate-500 font-medium border-b border-border">
                    <tr>
                        <th class="px-6 py-3 w-32">ID</th>
                        <th class="px-6 py-3">Account Name</th>
                        <th class="px-6 py-3">Group</th>
                        <th class="px-6 py-3 text-right">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-border">
                    {% for item in attention_accounts %}
                    <tr class="hover:bg-slate-50">
                        <td class="px-6 py-3 font-mono text-xs text-slate-500">{{ item.account_id }}</td>
                        <td class="px-6 py-3 font-medium text-slate-800">{{ item.name }}</td>
                        <td class="px-6 py-3 text-slate-600 text-xs">{{ item.monitor_group.name }}</td>
                        <td class="px-6 py-3 text-right">
                            <span class="bg-amber-100 text-amber-800 text-xs px-2 py-1 rounded font-medium">{{ item.status }}</span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">All systems nominal.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Ranking -->
        <div class="card p-6">
            <h3 class="text-sm font-bold text-slate-700 mb-4">Top Departments</h3>
            <div class="space-y-4">
                {% for dept in dept_ranking %}
                <div class="group">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-slate-600 font-medium group-hover:text-primary transition-colors">{{ dept.name }}</span>
                        <span class="text-slate-400 text-xs font-mono">{{ dept.acc_count }}</span>
                    </div>
                    <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                        <div class="bg-blue-500 h-full rounded-full" style="width: 80%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // „Ç∞„É©„Éï„ÅÆËâ≤Ë®≠ÂÆö„ÇÇÊòé„Çã„Åè„Åó„Åæ„Åô
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 6 } } },
        scales: { x: { grid: { display: false } }, y: { border: { dash: [4, 4] }, grid: { color: '#f1f5f9' } } }
    };

    new Chart(document.getElementById('providerChart'), {
        type: 'doughnut',
        data: {
            labels: JSON.parse('{{ chart_labels|safe }}'),
            datasets: [{
                data: JSON.parse('{{ chart_data|safe }}'),
                backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#6366F1', '#EC4899'],
                borderWidth: 0
            }]
        },
        options: { ...commonOptions, cutout: '80%' }
    });

    new Chart(document.getElementById('historyChart'), {
        type: 'bar',
        data: {
            labels: JSON.parse('{{ history_labels|safe }}'),
            datasets: [{
                label: 'New',
                data: JSON.parse('{{ history_data|safe }}'),
                backgroundColor: '#3B82F6',
                borderRadius: 4
            }]
        },
        options: { ...commonOptions, plugins: { legend: { display: false } } }
    });
</script>
{% endblock %}